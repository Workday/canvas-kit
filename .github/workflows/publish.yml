name: Publish to npm

# This workflow orchestrates ALL publishing to npm by delegating to reusable workflows:
# - Canary releases (automatic on prerelease/* branches) → canary.yml
# - Patch releases (automatic on master/support branches) → release.yml
# - Minor releases (manual workflow_dispatch) → release-minor.yml
# - Major releases (manual workflow_dispatch) → release-major.yml
#
# Commits containing [skip release] will skip publishing but still trigger forward-merge.
#
# IMPORTANT: Configure this workflow (publish.yml) as the ONLY trusted publisher on npm
# for all Canvas Kit packages.

on:
  push:
    branches:
      - master
      - support
      - 'prerelease/*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (minor or major)'
        required: true
        type: choice
        options:
          - minor
          - major

permissions:
  id-token: write # Required for OIDC
  contents: write

jobs:
  # Determine which type of publish to perform
  determine-publish-type:
    runs-on: ubuntu-latest
    outputs:
      publish_type: ${{ steps.determine.outputs.publish_type }}
      branch: ${{ steps.determine.outputs.branch }}
    steps:
      - name: Determine publish type
        id: determine
        run: |
          # For workflow_dispatch, use the selected release type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "publish_type=${{ inputs.release_type }}" >> $GITHUB_OUTPUT
            echo "branch=master" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For push events, determine type based on branch
          BRANCH="${{ github.ref_name }}"
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT

          if [[ "$BRANCH" == prerelease/* ]]; then
            echo "publish_type=canary" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "master" ]] || [[ "$BRANCH" == "support" ]]; then
            # Check if commit message contains [skip release]
            if [[ "${{ github.event.head_commit.message }}" == *"[skip release]"* ]]; then
              echo "publish_type=skip" >> $GITHUB_OUTPUT
            else
              echo "publish_type=release" >> $GITHUB_OUTPUT
            fi
          else
            echo "publish_type=skip" >> $GITHUB_OUTPUT
          fi

  # Call canary publish workflow for prerelease branches
  canary-publish:
    needs: determine-publish-type
    if: needs.determine-publish-type.outputs.publish_type == 'canary'
    uses: ./.github/workflows/canary.yml
    with:
      branch: ${{ needs.determine-publish-type.outputs.branch }}
    secrets:
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CHROMATIC_APP_CODE: ${{ secrets.CHROMATIC_APP_CODE }}

  # Call release publish workflow for master/support branches (automatic patch)
  release-publish:
    needs: determine-publish-type
    if: needs.determine-publish-type.outputs.publish_type == 'release'
    uses: ./.github/workflows/release.yml
    with:
      version: 'patch' # Automatic releases are always patch
      branch: ${{ needs.determine-publish-type.outputs.branch }}
      to_ref: '' # Not needed for patch releases
    secrets:
      GH_RW_TOKEN: ${{ secrets.GH_RW_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CHROMATIC_APP_CODE: ${{ secrets.CHROMATIC_APP_CODE }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

  # Call minor release workflow (manual workflow_dispatch)
  minor-release:
    needs: determine-publish-type
    if: needs.determine-publish-type.outputs.publish_type == 'minor'
    uses: ./.github/workflows/release-minor.yml
    secrets:
      GH_RW_TOKEN: ${{ secrets.GH_RW_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CHROMATIC_APP_CODE: ${{ secrets.CHROMATIC_APP_CODE }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

  # Call major release workflow (manual workflow_dispatch)
  major-release:
    needs: determine-publish-type
    if: needs.determine-publish-type.outputs.publish_type == 'major'
    uses: ./.github/workflows/release-major.yml
    secrets:
      GH_RW_TOKEN: ${{ secrets.GH_RW_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CHROMATIC_APP_CODE: ${{ secrets.CHROMATIC_APP_CODE }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
