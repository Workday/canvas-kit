import { Meta } from '@storybook/addon-docs';
import { Table } from '@workday/canvas-kit-react/table';
import { base, brand, system } from '@workday/canvas-tokens-web';
import { StatusIndicator } from '@workday/canvas-kit-preview-react/status-indicator';
import { cssVar } from '@workday/canvas-kit-styling';
import { Box } from '@workday/canvas-kit-react/layout';

<Meta title="Guides/Upgrade Guides/v13.0" />

# Canvas Kit 13.0 Upgrade Guide

This guide contains an overview of the changes in Canvas Kit v13. Please
[reach out](https://github.com/Workday/canvas-kit/issues/new?labels=bug&template=bug.md) if you have
any questions.


## Table of contents

- [Codemod](#codemod)
  - [Instructions](#instructions)
- [Component Updates](#component-updates)
  - [Styling API and CSS Tokens](#styling-api-and-css-tokens)
  - [Avatar](#avatar)
  - [Expandable](#expandable)
  - [External Hyperlink](#external-hyperlink)
	- [Form Field and Form Field Group](#form-field-and-form-field-group)
  - [Pill](#pill)
  - [Tabs](#tabs)
- [Brand Refresh](#brand-refresh)
  - [Logo Updates](#logo-updates)
- [Infrastructure](#infrastructure)
	- [Supporting react-jsx](#supoorting-react-jsx)
- [Troubleshooting](#troubleshooting)
- [Glossary](#glossary)
  - [Main](#main)
  - [Preview](#preview)
  - [Labs](#labs)

## Codemod

We've provided a [codemod](https://github.com/Workday/canvas-kit/tree/master/modules/codemod) to
automatically update your code to work with most of the breaking changes in v13. **Breaking changes
handled by the codemod are marked with 🤖 in the Upgrade Guide.**

A codemod is a script that makes programmatic transformations on your codebase by traversing the
[AST](https://www.codeshiftcommunity.com/docs/understanding-asts), identifying patterns, and making
prescribed changes. This greatly decreases opportunities for error and reduces the number of manual
updates, which allows you to focus on changes that need your attention. **We highly recommend you
use the codemod for these reasons.**

If you're new to running codemods or if it's been a minute since you've used one, there are a few
things you'll want to keep in mind.

- Our codemods are meant to be run sequentially. For example, if you're using v8 of Canvas Kit,
  you'll need to run the v9 codemod before you run v10 and so on.
- The codemod will update your code to be compatible with the specified version, but it will **not**
  remove outdated dependencies or upgrade dependencies to the latest version. You'll need to upgrade
  dependencies on your own.
  - We recommend upgrading dependencies before running the codemod.
  - Always review your `package.json` files to make sure your dependency versions look correct.
- The codemod will not handle every breaking change in v13. You will likely need to make some manual
  changes to be compatible. Use our Upgrade Guide as a checklist.
- Codemods are not bulletproof.
  - Conduct a thorough PR and QA review of all changes to ensure no regressions were introduced.
  - As a safety precaution, we recommend committing the changes from the codemod as a single
    isolated commit (separate from other changes) so you can roll back more easily if necessary.

We're here to help! Automatic changes to your codebase can feel scary. You can always reach out to
our team. We'd be very happy to walk you through the process to set you up for success.

### Instructions

The easiest way to run our codemod is to use `npx` in your terminal.

```sh
npx @workday/canvas-kit-codemod v13 [path]
```

Be sure to provide specific directories that need to be updated via the `[path]` argument. This
decreases the amount of AST the codemod needs to traverse and reduces the chances of the script
having an error. For example, if your source code lives in `src/`, use `src/` as your `[path]`. Or,
if you have a monorepo with three packages using Canvas Kit, provide those specific packages as your
`[path]`.

Alternatively, if you're unable to run the codemod successfully using `npx`, you can install the
codemod package as a dev dependency, run it with `yarn`, and then remove the package after you're
finished.

```sh
yarn add @workday/canvas-kit-codemod --dev
yarn canvas-kit-codemod v13 [path]
yarn remove @workday/canvas-kit-codemod
```

> **Note**: The codemod only works on `.js`, `.jsx`, `.ts`, and `.tsx` files. You'll need to
> manually edit other file types (`.json`, `.mdx`, `.md`, etc.). You may need to run your linter
> after executing the codemod, as its resulting formatting (spacing, quotes, etc.) may not match
> your project conventions.

## Component Updates

### Styling API and CSS Tokens

**PRs:** [#3101](https://github.com/Workday/canvas-kit/pull/3101), [#3088](https://github.com/Workday/canvas-kit/pull/3088), [#3114](https://github.com/Workday/canvas-kit/pull/3114), [#3119](https://github.com/Workday/canvas-kit/pull/3119), [#3120](https://github.com/Workday/canvas-kit/pull/3120), [#3164](https://github.com/Workday/canvas-kit/pull/3164), [#3128](https://github.com/Workday/canvas-kit/pull/3128), [#3123](https://github.com/Workday/canvas-kit/pull/3123), [#3205](https://github.com/Workday/canvas-kit/pull/3205), [#3210](https://github.com/Workday/canvas-kit/pull/3210), [#3240](https://github.com/Workday/canvas-kit/pull/3240)

Several components have been refactored to use our
[Canvas Tokens](https://workday.github.io/canvas-tokens/?path=/docs/docs-getting-started--docs) and
[styling API](https://workday.github.io/canvas-kit/?path=/docs/styling-basics--create-modifiers#createstyles-api).
The React interface **has not changed**, but CSS variables are now used for dynamic properties.

> **Note:** These components also support our `cs` prop for styling. Learn more about styling
> with `cs` in our
> [documentation](https://workday.github.io/canvas-kit/?path=/docs/styling-basics--cs-prop).

The following components are affected:

- `ActionBar`
- `Banner`
- `Expandable`
- `ExternalHyperlink`
- `LoadingSparkles`
- `Menu`
- `Pill`
- `Select`
- `SidePanel (Preview)`
- `Skeleton`
- `Tabs`
- `Tooltip`

### Avatar

**PR:** [#3231](https://github.com/Workday/canvas-kit/pull/3231)

A few changes have been made to `Avatar` to ensure proper accessibility.

##### Breaking Changes

- The `altText` prop no longer has a default of `"Avatar"` for better internalization. The default was an English word (“Avatar”) and this has caused issues in the past with translations.

>**Note:** You *must* provide an `altText` for `<Avatar />, <Pill.Avatar />, <Expandable.Avatar />` to ensure proper accessibility.  Our examples have been updated to reflect this change.

### Expandable

**PR:** [#3213](https://github.com/Workday/canvas-kit/pull/3213)

We've promoted `Expandable` from [Labs](#labs) to [Main](#main).

```tsx
// v12
import {Expandable} from '@workday/canvas-kit-labs-react/expandable';

// v13
import {Expandable} from '@workday/canvas-kit-react/expandable';
```

🤖 The codemod will handle the change of imports as shown above.

### External Hyperlink

**PR:** [#3101](https://github.com/Workday/canvas-kit/pull/3101)

`iconLabel` is now a *required* prop. We've removed the default `aria-label` of `Opens link in new window`  to better support internationalization. You must provide a value to `iconLabel`.

```tsx
//v12
<ExternalHyperlink href="https://workday.com">
  External Hyperlink
</ExternalHyperlink>

//v13
<ExternalHyperlink href="https://workday.com" iconLabel='Open link in new window'>
  External Hyperlink
</ExternalHyperlink>
```

### Form Field and Form Field Group
**PR:** [#3101](https://github.com/Workday/canvas-kit/pull/3101)

The `orientation` prop on `FormField` component has been updated to remove the deprecated `horizontal` value. v12 had a codemod to update this value to `horizontalStart`. In v13, we've dropped `horizontal` as a value.` You must update your code to use `horizontalStart`.

**Before in v12**
```tsx
<FormField orientation="horizontal">
	<FormField.Label>Label</FormField.Label>
	<FormField.Field>
		<FormField.Input as={TextInput} />
	<FormField.Field>
</FormField>
```

**After in v13**
```tsx
<FormField orientation="horizontalStart">
	<FormField.Label>Label</FormField.Label>
	<FormField.Field>
		<FormField.Input as={TextInput} />
	<FormField.Field>
</FormField>
```


### Pill

**PR:** [#3104](https://github.com/Workday/canvas-kit/pull/3104)

A few changes have been made to `Pill` to ensure proper accessibility and styles.

- The border color on hover has been updated from `licorice400` to `licorice500` to match our design specs.
- We've removed extra elements and leverage [flex box}(https://developer.mozilla.org/en-US/docs/Learn_web_development/Core/CSS_layout/Flexbox) to ensure only the label receives overflow styles. When `maxWidth` is set, it is set on the parent `<Pill/>` element and the child elements will be styled accordingly. Before v13, `maxWidth` wasn't calculating the width of all its elements and wasn't a true pixel value.

##### Breaking Changes

- `maxWidth` has been removed from the `usePillModel`. This config was used to style sub-components. With the refactor to use `data-part` and [stencils](https://workday.github.io/canvas-kit/?path=/docs/styling-basics--docs#create-stencil), it is no longer needed on the model. You can still apply `maxWidth` on the parent `<Pill>` element and the child elements will be styled accordingly.
- `<Pill.Icon/>` no longer has a default `aria-label="add"`. You *must* provide an `aria-label` for `<Pill.Icon/>` to ensure proper accessibility. Our examples have been updated to reflect this change.
- `<Pill.IconButton/>` no longer has a default `aria-label="remove"`. You *must* provide an `aria-label` for `<Pill.IconButton/>` to ensure proper accessibility. Our examples have been updated to reflect this change.
- `<Pill.Label/>` is a *required* element when using other sub-components like `<Pill.Icon/>` to ensure that the label truncates correctly.

### Tabs

**PR:** [#3119](https://github.com/Workday/canvas-kit/pull/3119)

- The `disabled` icon color has been updated to use `system.color.fg.disabled`. This has made the icon darker for better contrast.

**Note:** There should be no developer impact and the visual changes are safe to accept.

## Brand Refresh

### Logo Updates

We've removed the outdated Dub Logos in Main and promoted the new logos that were previously in our Preview package to Main as part of the brand refresh.

| Old Logo Name | New Logo Name |
| --------------- | ----------------- |
| dubLogoBlue | dubLogoPrimary |
| dubLogoWhite | dubLogoReversed |
| wdayLogoBlue | wdayLogoPrimary |
| wdayLogoWhite | wdayLogoReversed |

```tsx
// In v12
// Importing from Main common
import {dubLogoBlue} from "@workday/canvas-kit-react/common"

<div dangerouslySetInnerHTML={__html: dubLogoBlue} />

// Importing from Preview common
import {dubLogoPrimary} from "@workday/canvas-kit-preview-react/common"

<div dangerouslySetInnerHTML={__html: dubLogoPrimary} />

// In v13
// New logos have been promoted to Main common AND renamed
import {dubLogoPrimary} from "@workday/canvas-kit-preview-react/common"

<div dangerouslySetInnerHTML={__html: dubLogoPrimary} />
```

🤖 The codemod will handle the change of `'dubLogoBlue', 'dubLogoWhite', 'wdayLogoBlue', 'wdayLogoWhite'` to
`'dubLogoPrimary', 'dubLogoReversed', 'wdayLogoPrimary', 'wdayLogoReversed'` as shown above in the table. It will also handle
updating your imports.

From:
```tsx
import {dubLogoBlue} from "@workday/canvas-kit-react/common"
```
To:
```tsx
import {dubLogoPrimary} from "@workday/canvas-kit-react/common"
```


## Infrastructure

### Supporting `react-jsx`

We've updated the `jsx` flag in our `tsconfig` to `react-jsx`. As part of this change, we've also updated our peer dependencies for our packages to a minimum version of `react@17.0.0`. This change is to provide support for modern technologies like `vite` and ES modules.

##### Breaking Changes

If you're using `react@16.x.x`, you'll need to upgrade to `react@17.x.x` to use Canvas Kit v13.

>**Note:** You'll need to update the way `jsx` transpiles. The automatic runtime feature, enabled through the `@babel/preset-react` preset with the `runtime: "automatic"` option, handles the importing of functions that JSX transpiles to.

```sh

## Troubleshooting

## Glossary

### Main

Our Main package of Canvas Kit tokens, components, and utilities at `@workday/canvas-kit-react` has
undergone a full design and a11y review and is approved for use in product.

Breaking changes to code in Main will only occur during major version updates and will always be
communicated in advance and accompanied by migration strategies.

---

### Preview

Our Preview package of Canvas Kit tokens, components, and utilities at
`@workday/canvas-kit-preview-react` has undergone a full design and a11y review and is approved for
use in product, but may not be up to the high code standards upheld in the [Main](#main) package.
Preview is analagous to code in beta.

Breaking changes are unlikely, but possible, and can be deployed to Preview at any time without
triggering a major version update, though such changes will be communicated in advance and
accompanied by migration strategies.

Generally speaking, our goal is to eventually promote code from Preview to [Main](#main).
Occasionally, a component with the same name will exist in both [Main](#main) and Preview (for
example, see Segmented Control in [Preview](/components/buttons/segmented-control/) and
[Main](https://d2krrudi3mmzzw.cloudfront.net/v8/?path=/docs/components-buttons-segmented-control--basic)).
In these cases, Preview serves as a staging ground for an improved version of the component with a
different API. The component in [Main](#main) will eventually be replaced with the one in Preview.

---

### Labs

Our Labs package of Canvas Kit tokens, components, and utilities at `@workday/canvas-kit-labs-react`
has **not** undergone a full design and a11y review. Labs serves as an incubator space for new and
experimental code and is analagous to code in alpha.

Breaking changes can be deployed to Labs at any time without triggering a major version update and
may not be subject to the same rigor in communcation and migration strategies reserved for breaking
changes in [Preview](#preview) and [Main](#main).
`import { opacity } from "@workday/canvas-tokens-web/dist/es6/system"`
