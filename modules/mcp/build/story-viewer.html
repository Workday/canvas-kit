<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canvas Kit Story Viewer</title>
    <style>
      *, *::before, *::after { box-sizing: border-box; }
      html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; }
      body {
        font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
        background: #fff;
      }
      #story-frame {
        width: 100%;
        height: 100%;
        border: none;
      }
      #loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #666;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div id="loading">Loading story...</div>
    <script type="module">
      var messageId = 0;
      var pendingRequests = new Map();

      function request(method, params) {
        var id = ++messageId;
        var message = {jsonrpc: '2.0', id: id, method: method, params: params};
        window.parent.postMessage(message, '*');
        return new Promise(function(resolve, reject) {
          var timeout = setTimeout(function() {
            pendingRequests.delete(id);
            reject(new Error('Request timeout: ' + method));
          }, 5000);
          pendingRequests.set(id, {resolve: resolve, reject: reject, timeout: timeout});
        });
      }

      function notify(method, params) {
        window.parent.postMessage({jsonrpc: '2.0', method: method, params: params}, '*');
      }

      function renderStory(html) {
        document.getElementById('loading')?.remove();
        var frame = document.createElement('iframe');
        frame.id = 'story-frame';
        frame.style.width = '100%';
        frame.style.height = '100%';
        frame.style.border = 'none';
        document.body.appendChild(frame);
        frame.contentDocument.open();
        frame.contentDocument.write(html);
        frame.contentDocument.close();
      }

      window.addEventListener('message', function(event) {
        var data = event.data;
        if (!data || typeof data !== 'object') return;

        if (data.id !== undefined && pendingRequests.has(data.id)) {
          var pending = pendingRequests.get(data.id);
          clearTimeout(pending.timeout);
          pendingRequests.delete(data.id);
          if (data.error) {
            pending.reject(new Error(data.error.message || 'Unknown error'));
          } else {
            pending.resolve(data.result);
          }
          return;
        }

        if (data.method && data.method.includes('tool') && data.method.includes('result')) {
          var html = data.params?._meta?.storyHtml;
          if (html) {
            renderStory(html);
          }
        }
      });

      request('ui/initialize', {
        protocolVersion: '2026-01-26',
        appInfo: {name: 'Canvas Kit Story Viewer', version: '1.0.0'},
        appCapabilities: {},
      }).then(function() {
        notify('ui/notifications/initialized', {});
      }).catch(function() {});
    </script>
  </body>
</html>
